# CXL.cachemem IDE Key Refresh
This is a sample host software flow when it is refreshing the Keys/IVs associated with an active CXL.cachemem IDE Stream.
1. Host software sends ```CXL_IDE_KM.Query``` to discover EP's CXL.cachemem IDE capabilities and the current configuration of a port.
2. Host software sends ```CXL_IDE_KM.Get_Key``` to EP if ```QUERY_RESP.IV_Generation_Cap``` and ```QUERY_RESP.IDE_Key_Generation_Cap``` are set. This is to generate the Keys/IVs of TX direction. Otherwise software shall generate the Keys/IVs of TX direction by itself.
3. Host software generates the Keys/IVs of RX direction.
4. Host software construts ```CXL_IDE_KM.Key_Prog``` of TX direction with the Keys in step2. If IVs are generated by ```CXL_IDE_KM.Get_Key```, software shall copy the IVs into ```CXL_IDE_KM.Key_Prog``` and set ```CXL_IDE_KM.Key_Prog.Use_Default_IV``` as ```0``` to indicate that Port shall use the Initial IV specified at ```Offset 13h+KSIZE```. Otherwise software shall set  ```CXL_IDE_KM.Key_Prog.Use_Default_IV``` as ```1``` to indicate that Port shall use the Default IV construction. After that software sends ```CXL_IDE_KM.Key_Prog``` to EP.
5. Host software construts ```CXL_IDE_KM.Key_Prog``` of RX direction with the Keys in step3. Software shall set  ```CXL_IDE_KM.Key_Prog.Use_Default_IV``` as ```1``` to indicate that Port shall use the Default IV construction. After that software sends ```CXL_IDE_KM.Key_Prog``` to EP.
6. Host software programs Keys/IVs in step2 into ```Rx Encryption Key.Link_Enc_Key_Rx``` registers and ```Rx IV.Link_Enc_IV_Rx``` registers.
7. Host software programs Keys/IVs in step3 into ```Tx Encryption Key.Link_Enc_Key_Tx``` registers and ```Tx IV.Link_Enc_IV_Tx``` registers.
8. Host software sets ```Link Encryption Control.TXKeyValid``` and ```Link Encryption Control.RXKeyValid``` to indicate that the TX and RX pending keys have been programmed.
9. Host software instructs EP RX to be ready by sending ```CXL_IDE_KM.KSet_Go```.
10. Host software sets ```Link Encryption Control.StartTrigger```. On ```Link Encryption Control.StartTrigger```, hardware moves the pending key to active key by sampling ```TX Encryption Key.Link_Enc_Key_Tx``` and copying it into hardware storage. HW transmits ```IDE.Start flit``` and subsequently clears ```Link Encryption Control.TXKeyValid```.
11. Host software instructs EP TX to enable IDE by sending ```CXL_IDE_KM.KSet_Go```. EP TX transmits an ```IDE.Start flit```. On the Root Port RX side, upon receipt of ```IDE.Start flit```, hardware samples ```RX Encryption Key.Link_Enc_Key_Rx``` and copies it into hardware storage and clears ```Link Encryption Control.RXKeyValid```.
12. The CXL.cachemem IDE Keys are refreshed.